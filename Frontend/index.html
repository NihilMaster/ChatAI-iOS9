<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat para iOS 9 - Gemini/DeepSeek</title>
    <style>
        /* CSS compatible con iOS 9 Safari */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .chat-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 80vh;
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            -ms-flex-direction: column;
            flex-direction: column;
        }
        
        .chat-header {
            background-color: #007AFF;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .chat-messages {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            -ms-flex: 1;
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #007AFF;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .bot-message {
            background-color: #E8E8E8;
            color: black;
            margin-right: auto;
        }
        
        .typing-indicator {
            color: #666;
            font-style: italic;
            padding: 10px;
            display: none;
        }
        
        .chat-input-container {
            padding: 15px;
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            gap: 10px;
        }
        
        #message-input {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            -ms-flex: 1;
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
        }
        
        #send-button {
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #send-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .config-panel {
            background-color: #fff;
            padding: 15px;
            margin-top: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .config-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .error-message {
            background-color: #FF3B30;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>Chat IA - iOS 9</h1>
        </div>
        
        <div class="error-message" id="error-message"></div>
        
        <div class="chat-messages" id="chat-messages">
            <div class="message bot-message">
                ¡Hola! Soy un asistente de IA. Por favor, configura tu API key y backend URL para comenzar.
            </div>
        </div>
        
        <div class="typing-indicator" id="typing-indicator">
            La IA está escribiendo...
        </div>
        
        <div class="chat-input-container">
            <input type="text" id="message-input" placeholder="Escribe tu mensaje..." disabled>
            <button id="send-button" disabled>Enviar</button>
        </div>
    </div>
    
    <div class="config-panel">
        <h3>Configuración</h3>
        <input type="text" class="config-input" id="backend-url" 
               placeholder="URL de tu backend (ej: https://tu-backend.onrender.com)">
        <input type="text" class="config-input" id="api-key" 
               placeholder="Tu API Key de Gemini o DeepSeek">
        <button id="save-config">Guardar Configuración</button>
    </div>

    <script>
        // JavaScript ES5 puro - Compatible con iOS 9 Safari
        
        // Elementos del DOM
        var chatMessages = document.getElementById('chat-messages');
        var messageInput = document.getElementById('message-input');
        var sendButton = document.getElementById('send-button');
        var typingIndicator = document.getElementById('typing-indicator');
        var errorMessage = document.getElementById('error-message');
        var backendUrlInput = document.getElementById('backend-url');
        var apiKeyInput = document.getElementById('api-key');
        var saveConfigButton = document.getElementById('save-config');
        
        // Configuración
        var config = {
            backendUrl: '',
            apiKey: ''
        };
        
        // Cargar configuración guardada
        function loadConfig() {
            var savedConfig = localStorage.getItem('chatConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                backendUrlInput.value = config.backendUrl;
                apiKeyInput.value = config.apiKey;
                updateUI();
            }
        }
        
        // Guardar configuración
        saveConfigButton.addEventListener('click', function() {
            config.backendUrl = backendUrlInput.value.trim();
            config.apiKey = apiKeyInput.value.trim();
            
            if (config.backendUrl && config.apiKey) {
                localStorage.setItem('chatConfig', JSON.stringify(config));
                showMessage('Configuración guardada correctamente', 'bot');
                updateUI();
            } else {
                showError('Por favor, completa ambos campos de configuración');
            }
        });
        
        // Actualizar UI según configuración
        function updateUI() {
            var isConfigured = config.backendUrl && config.apiKey;
            messageInput.disabled = !isConfigured;
            sendButton.disabled = !isConfigured;
            
            if (isConfigured) {
                messageInput.placeholder = 'Escribe tu mensaje...';
                showMessage('Configuración cargada. ¡Ya puedes chatear!', 'bot');
            }
        }
        
        // Mostrar mensaje en el chat
        function showMessage(text, sender) {
            var messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Mostrar error
        function showError(text) {
            errorMessage.textContent = text;
            errorMessage.style.display = 'block';
            setTimeout(function() {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // Enviar mensaje a la IA
        function sendMessage() {
            var message = messageInput.value.trim();
            if (!message) return;
            
            // Mostrar mensaje del usuario
            showMessage(message, 'user');
            messageInput.value = '';
            
            // Mostrar indicador de typing
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Preparar datos para la API
            var requestData = {
                message: message,
                apiKey: config.apiKey
            };
            
            // Usar XMLHttpRequest (compatible con iOS 9)
            var xhr = new XMLHttpRequest();
            xhr.open('POST', config.backendUrl + '/chat', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    typingIndicator.style.display = 'none';
                    
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.success && response.message) {
                                showMessage(response.message, 'bot');
                            } else {
                                showError('Error en la respuesta: ' + (response.error || 'Respuesta inválida'));
                            }
                        } catch (e) {
                            showError('Error al procesar la respuesta: ' + e.message);
                        }
                    } else {
                        showError('Error de conexión: ' + xhr.status + ' - ' + xhr.statusText);
                    }
                }
            };
            
            xhr.onerror = function() {
                typingIndicator.style.display = 'none';
                showError('Error de red. Verifica tu conexión y la URL del backend.');
            };
            
            xhr.timeout = 30000; // 30 segundos timeout
            xhr.ontimeout = function() {
                typingIndicator.style.display = 'none';
                showError('Timeout: La respuesta tardó demasiado tiempo.');
            };
            
            try {
                xhr.send(JSON.stringify(requestData));
            } catch (e) {
                typingIndicator.style.display = 'none';
                showError('Error al enviar la petición: ' + e.message);
            }
        }
        
        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.keyCode === 13) { // Enter key
                sendMessage();
            }
        });
        
        // Inicializar
        loadConfig();
        
        // Mensaje de bienvenida adicional después de cargar
        setTimeout(function() {
            if (!config.backendUrl || !config.apiKey) {
                showMessage('Para comenzar: 1) Consigue una API Key de Google Gemini o DeepSeek. 2) Despliega el backend. 3) Configura los datos abajo.', 'bot');
            }
        }, 1000);
    </script>
</body>
</html>